<div id="title">
	<span>
		<h1><%= @branch.name %></h1>
		<% if @branch.created_by == @user.id %>
			<%= link_to "Add Element", branch_elements_path(@branch), :rel => "facebox", :class => "right metal in_title" %>
		<% else %>
			<% if @user.following? @branch %>
				<%= link_to "Stop Following", stop_following_branch_path(@branch), :class =>  "right metal in_title" %>
			<% else %>
				<%= link_to "Follow", follow_branch_path(@branch), :class =>  "right metal in_title" %>
			<% end %>
		<% end %>
	</span>
</div>

<div id="main">
	<div id="show_branch">
		<div class="right_pane">
			
			<div class="branch_followers branch_frame">
				
				
			</div>

			<%= render :partial => "/links/index" if @branch.has? :links %>
			<%= render :partial => "/attachments/index" if @branch.has? :attachments %>
			<%= render :partial => "/images/index" if @branch.has? :images %>
			<%= render :partial => "/feed/index" if @branch.has? :feed %>
			
		</div>
		
		<div class="left_pane">
			
			<div class="description"> 
				<%= @branch.description %>
			</div>
			
			<%= render :partial => "/maps/index" if @branch.has? :maps %>
			<%= render :partial => "/notes/index" if @branch.has? :notes %>
		
			<div id="comments" class="comments round">
				<% if @branch.comments.size > 5 %>
				<%= link_to "Show all #{@branch.comments.size} comments", "#", :class => "show_all_comments" %>
				
				<div id="hidden_comments" style="display:none">
					<% for comment in @branch.comments.first(@branch.comments.size - 5) %>
						<%= render :partial => "comments/ui/post", :locals => { :comment => comment } %>
					<% end %>
				</div>
				<% end %>
	
				<% for comment in @branch.comments.last(5) %>
					<%= render :partial => "comments/ui/post", :locals => { :comment => comment } %>
				<% end %>
				
				<div id="comment_lander"></div>
				
				<p class="add_comment"><%= image_tag(avatar_url(@user, :small)) %><input value="Write a comment" class="add_comment"/></p>
				<% form_for :comment, :url => branch_comments_path(@branch), :html => { :class => "comments_form", :rel => "#comment_lander" } do |f| %>
				<p class="new_comment" style="display:none">
					<%= f.text_area :message, :class => "new_comment round" %>
					<%= f.submit "post comment", :class => "metal new_comment" %>
				</p>
				<% end %>
			</div>
			
		</div>
		
	</div>
</div>

<script>
	$(document).ready(function(){
		
		// Element Exit 
		
		
		$('div.element_frame').hover(function(){
			element = $(this).attr('rel');
			$("." + element + "_header").css("display", "")
		},
		function() {
			$(".element_header").css("display", "none")
		}
		
		);
		
		// Comment links 
		
		$(".show_all_comments").click(function(){
			$("#hidden_comments").show();
			$(this).hide();
			return false;
		});
		
		$(".comment_link").click(function() {
			$("div#"+$(this).attr("id")).css("display", "");
		});

		$("p.add_comment").click(function() {
			$(this).css("display","none");
			$("p.new_comment").css("display", "");
			$("textarea.new_comment").focus();
		});
		
		$("textarea.new_comment").blur(function(){
			if($(this).val() == "") {
				$("p.new_comment").css("display", "none");
				$("p.add_comment").css("display", "");
			}
		});

		// Ajax Comment form
		$("form.comments_form").submit(function(){
			var append_to = $(this).attr("rel");
			$(this).ajaxSubmit({
				success: function(data) {
					$(append_to).append(data);
					$("textarea.new_comment").attr("value", "");
					$("p.new_comment").css("display", "none");
					$("p.add_comment").css("display", "");
				}
			})
			return false;
		});
	});
</script>